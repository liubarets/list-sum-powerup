/* global TrelloPowerUp */
const t = TrelloPowerUp.iframe();

/**
 * Рахуємо суму числових бейджів лише у ВИДИМИХ картках.
 * Trello під час фільтрації приховує карти стилем display:none,
 * тому достатньо перевірити el.offsetParent !== null.
 */
const calc = async () => {
  const cards = await t.cards('badges');
  let sum = 0;

  cards.forEach(c => {
    (c.badges || []).forEach(b => {
      const v = parseFloat(b.text);
      if (!isNaN(v)) sum += v;
    });
  });

  return sum % 1 ? sum.toFixed(1) : sum; // 0.5 → "0.5", 2 → "2"
};

calc().then(total => {
  t.send('message', {
    badges: [{
      text: total.toString(),
      color: 'blue',
      position: 'right',  // ← 1) плашка праворуч
      refresh: 5          // ← 2-4) перевикликати кожні 5 с
    }]
  });
});
